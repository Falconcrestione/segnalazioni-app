<!DOCTYPE html>
<html lang="it">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Dashboard Veicoli & Reports</title>

<!-- LEAFLET -->
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" />
<link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.css" />
<link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.Default.css" />

<style>
body { font-family: Arial; background:#f4f6f9; padding:20px; }
h2 { margin-top:30px; }
#map { height:400px; margin-bottom:20px; border-radius:10px; }
table { width:100%; border-collapse:collapse; background:#fff; }
th { background:#0070f3; color:#fff; padding:8px; }
td { padding:8px; border-bottom:1px solid #ddd; }
select, input { padding:8px; margin-right:5px; }
button { padding:6px 10px; border:none; border-radius:5px; cursor:pointer; }
.btn-approve { background:#0070f3; color:#fff; }
.btn-reject { background:#dc3545; color:#fff; }
</style>
</head>

<body>

<h1>üöì Dashboard Gestione Veicoli & Reports</h1>

<!-- SELETTORE DISTRETTO / SUPERUSER -->
<div style="margin-bottom:20px;">
  <b>Vista:</b>
  <select id="distrettoSelector" onchange="checkPassword()">
    <option value="">-- Seleziona --</option>
    <option value="ALL">üåç Superuser ‚Äì Tutti i distretti</option>
    <option value="Distretto 1">Distretto 1</option>
    <option value="Distretto 2">Distretto 2</option>
    <option value="Distretto 3">Distretto 3</option>
    <option value="Distretto 4">Distretto 4</option>
    <option value="Distretto 5">Distretto 5</option>
  </select>
</div>

<div id="map"></div>

<!-- REPORTS -->
<h2>üìÑ Reports</h2>
<table>
<thead>
<tr>
  <th>Distretto</th>
  <th>Comparto</th>
  <th>Tipo Veicolo</th>
  <th>Targa</th>
  <th>PDF</th>
  <th>Foto</th>
</tr>
</thead>
<tbody id="reportsBody"></tbody>
</table>

<!-- VEICOLI -->
<h2>üöó Veicoli</h2>
<table>
<thead>
<tr>
  <th>Targa</th>
  <th>Modello</th>
  <th>Stato</th>
  <th>Distretto</th>
</tr>
</thead>
<tbody id="veicoliBody"></tbody>
</table>

<!-- RICHIESTE -->
<h2>üì® Richieste Veicoli</h2>
<table>
<thead>
<tr>
  <th>Nome</th>
  <th>Email</th>
  <th>Veicolo</th>
  <th>Distretto</th>
  <th>Stato</th>
  <th>Azione</th>
</tr>
</thead>
<tbody id="richiesteBody"></tbody>
</table>

<!-- FIREBASE -->
<script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-firestore-compat.js"></script>

<!-- LEAFLET -->
<script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
<script src="https://unpkg.com/leaflet.markercluster@1.5.3/dist/leaflet.markercluster.js"></script>

<script>
/* ================= FIREBASE ================= */
firebase.initializeApp({
  apiKey: "AIzaSyCdYoHrYI9zQdxhQOdaVT7o1lIQg8SRwAg",
  authDomain: "attendance-2980e.firebaseapp.com",
  projectId: "attendance-2980e",
});
const db = firebase.firestore();

/* ================= MAPPA ================= */
const map = L.map("map").setView([38.1, 15.6], 12);
L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png").addTo(map);
const markers = L.markerClusterGroup();
map.addLayer(markers);

/* ================= PASSWORD ================= */
const passwords = {
  ALL: "superpass123",
  "Distretto 1": "distretto1pass",
  "Distretto 2": "distretto2pass",
  "Distretto 3": "distretto3pass",
  "Distretto 4": "distretto4pass",
  "Distretto 5": "distretto5pass"
};

// Variabile di accesso
let accessGranted = false;

function checkPassword() {
  const select = document.getElementById("distrettoSelector");
  const user = select.value;
  if (!user) return;

  const pw = prompt("Inserisci la password per " + user);
  if (pw !== passwords[user]) {
    alert("Password errata!");
    select.value = "";
    accessGranted = false;
    clearAllTables();
    return;
  }

  alert("Accesso consentito: " + user);
  accessGranted = true;
  reloadAll();
}

function distrettoAttivo() {
  return document.getElementById("distrettoSelector").value;
}

/* ================= FUNZIONI DI CARICAMENTO ================= */
function clearAllTables() {
  document.getElementById("reportsBody").innerHTML = "";
  document.getElementById("veicoliBody").innerHTML = "";
  document.getElementById("richiesteBody").innerHTML = "";
  markers.clearLayers();
}

function loadReports() {
  if (!accessGranted) return;
  const body = document.getElementById("reportsBody");
  body.innerHTML = "";
  markers.clearLayers();

  db.collection("reports").onSnapshot(snap => {
    body.innerHTML = "";
    markers.clearLayers();
    snap.forEach(doc => {
      const d = doc.data();
      if (distrettoAttivo() !== "ALL" && d.distretto !== distrettoAttivo()) return;

      body.innerHTML += `
        <tr>
          <td>${d.distretto}</td>
          <td>${d.comparto}</td>
          <td>${d.tipoVeicolo}</td>
          <td>${d.targa}</td>
          <td>${d.pdf ? `<a href="${d.pdf}" target="_blank">PDF</a>` : "-"}</td>
          <td>${d.jpg ? `<a href="${d.jpg}" target="_blank">Foto</a>` : "-"}</td>
        </tr>
      `;

      if (d.latitudine && d.longitudine) {
        markers.addLayer(L.marker([d.latitudine, d.longitudine]));
      }
    });
  });
}

function loadVeicoli() {
  if (!accessGranted) return;
  const body = document.getElementById("veicoliBody");
  body.innerHTML = "";

  db.collection("veicoli").onSnapshot(snap => {
    body.innerHTML = "";
    snap.forEach(doc => {
      const v = doc.data();
      if (distrettoAttivo() !== "ALL" && v.distretto !== distrettoAttivo()) return;

      body.innerHTML += `
        <tr>
          <td>${v.targa}</td>
          <td>${v.modello}</td>
          <td>${v.stato}</td>
          <td>${v.distretto}</td>
        </tr>
      `;
    });
  });
}

function loadRichieste() {
  if (!accessGranted) return;
  const body = document.getElementById("richiesteBody");
  body.innerHTML = "";

  db.collection("richieste").onSnapshot(snap => {
    body.innerHTML = "";
    snap.forEach(doc => {
      const r = doc.data();
      if (distrettoAttivo() !== "ALL" && r.distretto !== distrettoAttivo()) return;

      body.innerHTML += `
        <tr>
          <td>${r.nome}</td>
          <td>${r.email}</td>
          <td>${r.veicolo}</td>
          <td>${r.distretto}</td>
          <td>${r.status}</td>
          <td>
            <button class="btn-approve" onclick="db.collection('richieste').doc('${doc.id}').update({status:'approvata'})">OK</button>
            <button class="btn-reject" onclick="db.collection('richieste').doc('${doc.id}').update({status:'rifiutata'})">NO</button>
          </td>
        </tr>
      `;
    });
  });
}

function reloadAll() {
  if (!accessGranted) return;
  loadReports();
  loadVeicoli();
  loadRichieste();
}

// inizialmente niente da mostrare
clearAllTables();
</script>

</body>
</html>
